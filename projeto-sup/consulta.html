<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Pública — PROJETO SUP</title>
  <style>
    :root { --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#84cc16; --warn:#f59e0b; --bad:#ef4444; --border:#1f2937; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#060b18,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"}
    .container{max-width:860px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#22d3ee,#10b981);display:grid;place-items:center;color:#061018;font-weight:900}
    h1{font-size:clamp(20px,3vw,26px);margin:0}
    .card{background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid .col-2{grid-column:span 2}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    .button{cursor:pointer;border:1px solid var(--border);background:#0b1220;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600}
    .button.primary{background:linear-gradient(135deg,#0891b2,#22d3ee);color:#061018;border:none}
    .button.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .row{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .result{margin-top:16px}
    .title{font-weight:800;font-size:18px;margin:0 0 4px}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block}
    .pill.ok{background:rgba(132,204,22,.15);color:#c4f25f}
    .pill.warn{background:rgba(245,158,11,.15);color:#ffd27a}
    .pill.bad{background:rgba(239,68,68,.15);color:#fda4a4}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:6px 12px;margin-top:8px}
    .kv label{color:var(--muted)}
    .notes{white-space:pre-wrap;background:#0b1220;border:1px dashed var(--border);border-radius:12px;padding:10px}
    .actions{display:flex;gap:8px;margin-top:10px}
    .center{display:flex;justify-content:center;align-items:center;gap:8px;color:var(--muted);padding:24px}
    .warnbox{border:1px dashed var(--border);border-radius:12px;padding:10px;font-size:12px;color:var(--muted)}
    @media print{ body{background:#fff;color:#000} .card{box-shadow:none;border:1px solid #ccc} .button{display:none} header,.warnbox{display:none} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">SUP</div>
      <div>
        <h1>Consulta Pública — PROJETO SUP</h1>
        <div class="muted">Acompanhe o andamento do seu protocolo com o <strong>Número</strong> e a <strong>Chave de Consulta Pública</strong>.</div>
      </div>
    </header>

    <div class="card" style="margin-top:12px">
      <div class="grid">
        <div>
          <label for="numero">Número do Protocolo</label>
          <input id="numero" placeholder="Ex.: PROTO-2025-001" />
        </div>
        <div>
          <label for="chave">Chave de Consulta Pública</label>
          <input id="chave" placeholder="Ex.: ABCD-1234" />
        </div>
        <div class="row col-2">
          <button class="button primary" id="btnBuscar">Buscar</button>
          <button class="button" id="btnLimpar">Limpar</button>
          <button class="button ghost" id="btnLink">Copiar link desta consulta</button>
        </div>
      </div>
      <div class="warnbox" style="margin-top:10px">Privacidade: esta página lê apenas o que está no <code>localStorage</code> deste navegador, salvo pelo próprio SUP. Para publicar para todos, será preciso um backend (futuro).</div>
    </div>

    <div id="resultado" class="result"></div>

    <div class="center" id="vazio">
      <span>Digite o número e a chave para consultar.</span>
    </div>
  </div>

  <script>
    const $ = (q, el=document)=> el.querySelector(q);
    const STORAGE_KEY = 'supCatalog';

    function loadData(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): []; }
      catch(e){ console.error('Erro ao ler localStorage', e); return []; }
    }

    function statusPill(s){ const map={OK:'ok',PENDENTE:'warn',IRREGULAR:'bad'}; const cls=map[s]||'ok'; return `<span class="pill ${cls}">${s||'OK'}</span>`; }
    function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)? iso : d.toLocaleString('pt-BR'); }
    function htmlEscape(s=''){ return (s+'').replace(/[&<>\"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

    // === Helpers extras (v0.5) ===
    function formatCNPJ(raw=''){
      const d = (raw||'').replace(/\D/g,'').slice(0,14);
      return d.length===14 ? d.slice(0,2)+'.'+d.slice(2,5)+'.'+d.slice(5,8)+'/'+d.slice(8,12)+'-'+d.slice(12) : (raw||'');
    }
    function fmtISODateToBR(isoOrYmd=''){
      if(!isoOrYmd) return '';
      if(/^\d{4}-\d{2}-\d{2}/.test(isoOrYmd)){
        const [y,m,d] = isoOrYmd.split('-');
        return `${d}/${m}/${y}`;
      }
      const d = new Date(isoOrYmd);
      return isNaN(d) ? isoOrYmd : d.toLocaleDateString('pt-BR');
    }
    function safeLink(url){
      try{ const u = new URL(url); return `<a href="${htmlEscape(u.toString())}" target="_blank" rel="noopener">Abrir</a>`; }
      catch{ return htmlEscape(url||''); }
    }
    // Fallback: extrai Organismo/CNPJ/Descrição das notas caso não estejam estruturados
    function extractMetaFromNotes(notes=''){
      const lines = (notes||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const meta = { organismoNome:'', organismoCNPJ:'', descricao:'' };
      for(const line of lines){
        const l = line.toLowerCase();
        if(!meta.organismoNome && l.startsWith('organismo:')) meta.organismoNome = line.split(':').slice(1).join(':').trim();
        if(!meta.organismoCNPJ && l.startsWith('cnpj:')) meta.organismoCNPJ = line.split(':').slice(1).join(':').trim();
        if(!meta.descricao && (l.startsWith('descrição:') || l.startsWith('descricao:'))) meta.descricao = line.split(':').slice(1).join(':').trim();
      }
      return meta;
    }

    function findProto(numero, chave){
      const data = loadData();
      const num = (numero||'').trim().toLowerCase();
      const key = (chave||'').trim().toLowerCase();
      return data.find(r=> (r.category||'').toLowerCase()==='protocolo'
                        && r.protocolo
                        && (r.protocolo.numero||'').toLowerCase()===num
                        && (r.protocolo.chave||'').toLowerCase()===key );
    }

    function renderResult(r){
      const box = $('#resultado');
      const empty = $('#vazio');
      if(!r){ box.innerHTML = ''; empty.style.display='flex'; return; }
      empty.style.display='none';
      const p = r.protocolo||{};

      // Metadados do organismo (estruturados ou extraídos das Notas)
      const fb = extractMetaFromNotes(r.notes||'');
      const organismoNome = r.organismoNome || fb.organismoNome || '';
      const organismoCNPJ = r.organismoCNPJ || fb.organismoCNPJ || '';
      const descricao     = r.descricao     || fb.descricao     || '';

      // Campos adicionais (v0.5)
      const tipoDemanda = r.tipoDemanda || '';
      const prioridade  = r.prioridade  || '';
      const responsavel = r.responsavel || '';
      const prazo       = fmtISODateToBR(r.prazo || '');
      const anexoUrl    = r.anexoUrl || '';

      // Histórico em linhas — data opcional no início
      const lines = (r.notes||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const reDate = /^(\d{2}[\/\-]\d{2}[\/\-]\d{4}|\d{4}[\-\/]\d{2}[\-\/]\d{2})\s?[–—-]?\s?/;
      const histHTML = lines.map(line=>{
        const m = line.match(reDate);
        const date = m ? m[1] : '';
        const rest = m ? line.replace(reDate,'') : line;
        const pill = (r.status==='OK'?'ok':(r.status==='IRREGULAR'?'bad':'warn'));
        return `<div style="display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:start">
                  <div><span class="pill ${pill}">${date||''}</span></div>
                  <div>${rest.replace(/</g,'&lt;')}</div>
                </div>`;
      }).join('') || '<div class="muted">Sem histórico informado.</div>';

      box.innerHTML = `
        <div class="card">
          <div class="title">${htmlEscape(r.name||'Protocolo')}</div>
          <div class="muted" style="margin-bottom:6px">ID: <code>${htmlEscape(r.id||'')}</code></div>
          <div class="kv">
            <label>Número</label><div><strong>${htmlEscape(p.numero||'')}</strong></div>
            <label>Chave</label><div><code>${htmlEscape(p.chave||'')}</code></div>
            <label>Status</label><div>${statusPill(r.status)}</div>
            <label>Atualizado em</label><div>${fmt(r.updatedAt)}</div>

            <label>Organismo</label><div>${htmlEscape(organismoNome) || '<span class="muted">—</span>'}</div>
            <label>CNPJ</label><div>${htmlEscape(formatCNPJ(organismoCNPJ)) || '<span class="muted">—</span>'}</div>

            <label>Descrição</label>
            <div class="notes">${(descricao || '<span class="muted">—</span>').replace(/</g,'&lt;')}</div>

            <label>Tipo da demanda</label><div>${htmlEscape(tipoDemanda) || '<span class="muted">—</span>'}</div>
            <label>Prioridade</label><div>${htmlEscape(prioridade) || '<span class="muted">—</span>'}</div>
            <label>Responsável</label><div>${htmlEscape(responsavel) || '<span class="muted">—</span>'}</div>
            <label>Prazo</label><div>${prazo || '<span class="muted">—</span>'}</div>
            <label>Anexo</label><div>${anexoUrl ? safeLink(anexoUrl) : '<span class="muted">—</span>'}</div>

            <label>Histórico</label>
            <div class="notes">${histHTML}</div>
          </div>
          <div class="actions">
            <button class="button" id="btnImprimir">Imprimir / PDF</button>
            <button class="button ghost" id="btnCopiarNumero">Copiar nº</button>
            <button class="button ghost" id="btnCopiarChave">Copiar chave</button>
          </div>
        </div>`;

      $('#btnImprimir').onclick     = ()=> window.print();
      $('#btnCopiarNumero').onclick = ()=> navigator.clipboard?.writeText(p.numero||'');
      $('#btnCopiarChave').onclick  = ()=> navigator.clipboard?.writeText(p.chave||'');
    }

    function doSearch(){
      const numero = $('#numero').value;
      const chave = $('#chave').value;
      const rec = findProto(numero, chave);
      if(rec) renderResult(rec); else {
        renderResult(null);
        const box = $('#resultado');
        box.innerHTML = `<div class="card"><div class="muted">Nenhum protocolo encontrado com os dados informados.</div></div>`;
      }
      const url = new URL(location.href);
      url.searchParams.set('n', numero.trim());
      url.searchParams.set('k', chave.trim());
      history.replaceState({}, '', url);
    }

    function fromURL(){
      const url = new URL(location.href);
      const n = url.searchParams.get('n')||'';
      const k = url.searchParams.get('k')||'';
      if(n) $('#numero').value = n;
      if(k) $('#chave').value = k;
      if(n && k) doSearch();
    }

    $('#btnBuscar').addEventListener('click', doSearch);
    $('#btnLimpar').addEventListener('click', ()=>{ $('#numero').value=''; $('#chave').value=''; history.replaceState({},'', location.pathname); renderResult(null); });
    $('#btnLink').addEventListener('click', ()=>{
      const url = new URL(location.href);
      const n=$('#numero').value.trim(), k=$('#chave').value.trim();
      if(n) url.searchParams.set('n', n); if(k) url.searchParams.set('k', k);
      navigator.clipboard?.writeText(url.toString());
      alert('Link copiado!');
    });

    $('#numero').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});
    $('#chave').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});

    fromURL();
  </script>
</body>
</html>
